<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kindred - Connecting Generations</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>
    <style>
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; }
        .nav-btn { transition: all 0.2s; }
        .nav-btn:hover { background-color: #f3f4f6; }
        .nav-btn.active { background-color: #2563eb; color: white; }
        .card { transition: box-shadow 0.2s; }
        .card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .section { display: none; }
        .section.active { display: block; }
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000;
        }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { 
            background: white; 
            padding: 2rem; 
            border-radius: 1rem; 
            max-width: 500px; 
            width: 90%; 
            max-height: 80vh; 
            overflow-y: auto;
        }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen bg-gray-50">
        <!-- Auth Modal -->
        <div id="authModal" class="modal active">
            <div class="modal-content">
                <div class="text-center mb-6">
                    <svg width="48" height="48" viewBox="0 0 100 100" class="w-12 h-12 mx-auto mb-4">
                        <defs>
                            <linearGradient id="heartGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#1e40af;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <circle cx="35" cy="25" r="12" fill="url(#heartGradient)" />
                        <path d="M 20 35 Q 20 30 25 30 L 45 30 Q 50 30 50 35 L 50 65 Q 50 75 35 75 Q 20 75 20 65 Z" fill="url(#heartGradient)" />
                        <circle cx="58" cy="30" r="8" fill="#1e40af" />
                        <path d="M 48 38 Q 48 35 50 35 L 66 35 Q 68 35 68 38 L 68 60 Q 68 65 58 65 Q 48 65 48 60 Z" fill="#1e40af" />
                        <path d="M 50 75 Q 35 60 25 45 Q 20 35 30 35 Q 40 35 50 50 Q 60 35 70 35 Q 80 35 75 45 Q 65 60 50 75 Z" fill="url(#heartGradient)" opacity="0.8" />
                    </svg>
                    <h1 class="text-3xl font-bold text-gray-800">Kindred</h1>
                    <p class="text-gray-600">Connecting generations</p>
                </div>
                
                <div id="authTabs" class="flex mb-6 bg-gray-100 rounded-lg p-1">
                    <button onclick="showAuthTab('login')" id="loginTab" class="flex-1 py-2 px-4 rounded-md bg-white shadow-sm font-medium">Sign In</button>
                    <button onclick="showAuthTab('signup')" id="signupTab" class="flex-1 py-2 px-4 rounded-md font-medium text-gray-600">Sign Up</button>
                </div>
                
                <!-- Login Form -->
                <div id="loginForm" class="auth-form active">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="loginEmail" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="loginPassword" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-medium">
                        Sign In
                    </button>
                </div>
                
                <!-- Signup Form -->
                <div id="signupForm" class="auth-form">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                        <input type="email" id="signupEmail" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="signupPassword" class="w-full p-3 border rounded-lg" minlength="6" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                        <input type="text" id="signupName" class="w-full p-3 border rounded-lg" required>
                    </div>
                    <button onclick="handleSignup()" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-medium">
                        Create Account
                    </button>
                </div>
                
                <div id="authMessage" class="mt-4 text-center text-sm"></div>
                
                <!-- Demo Login Option -->
                <div class="mt-6 pt-6 border-t">
                    <p class="text-center text-sm text-gray-600 mb-3">Quick Demo Access:</p>
                    <button onclick="enterDemoMode()" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 font-medium">
                        Try Demo (No Signup Required)
                    </button>
                </div>
            </div>
        </div>

        <!-- Add/Edit Grandchild Modal -->
        <div id="grandchildModal" class="modal">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modalTitle" class="text-2xl font-bold">Add Grandchild</h2>
                    <button onclick="closeGrandchildModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div id="grandchildForm">
                    <input type="hidden" id="grandchildId">
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name *</label>
                        <input type="text" id="grandchildName" class="w-full p-3 border rounded-lg" required>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Age</label>
                            <input type="number" id="grandchildAge" class="w-full p-3 border rounded-lg" min="1" max="25">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Birthday</label>
                            <input type="date" id="grandchildBirthday" class="w-full p-3 border rounded-lg">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">School</label>
                        <input type="text" id="grandchildSchool" class="w-full p-3 border rounded-lg">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Interests (comma separated)</label>
                        <input type="text" id="grandchildInterests" class="w-full p-3 border rounded-lg" placeholder="Gaming, Soccer, Drawing">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Communication Platforms (comma separated)</label>
                        <input type="text" id="grandchildPlatforms" class="w-full p-3 border rounded-lg" placeholder="Instagram, Discord, TikTok">
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Notes</label>
                        <textarea id="grandchildNotes" class="w-full p-3 border rounded-lg" rows="3"></textarea>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeGrandchildModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400">
                            Cancel
                        </button>
                        <button onclick="saveGrandchild()" class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">
                            Save
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Journal Entry Modal -->
        <div id="journalModal" class="modal">
            <div class="modal-content">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">Add Journal Entry</h2>
                    <button onclick="closeJournalModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div id="journalForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Grandchild</label>
                        <select id="journalGrandchild" class="w-full p-3 border rounded-lg" required>
                            <option value="">Select a grandchild</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title *</label>
                        <input type="text" id="journalTitle" class="w-full p-3 border rounded-lg" required>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Date</label>
                        <input type="date" id="journalDate" class="w-full p-3 border rounded-lg" required>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">What happened? *</label>
                        <textarea id="journalContent" class="w-full p-3 border rounded-lg" rows="4" required></textarea>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeJournalModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400">
                            Cancel
                        </button>
                        <button onclick="saveJournalEntry()" class="flex-1 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700">
                            Save Entry
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <nav class="bg-white shadow-lg border-b">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                        <svg width="32" height="32" viewBox="0 0 100 100" class="w-8 h-8">
                            <defs>
                                <linearGradient id="heartGradient2" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#60a5fa;stop-opacity:1" />
                                    <stop offset="100%" style="stop-color:#1e40af;stop-opacity:1" />
                                </linearGradient>
                            </defs>
                            <circle cx="35" cy="25" r="12" fill="url(#heartGradient2)" />
                            <path d="M 20 35 Q 20 30 25 30 L 45 30 Q 50 30 50 35 L 50 65 Q 50 75 35 75 Q 20 75 20 65 Z" fill="url(#heartGradient2)" />
                            <circle cx="58" cy="30" r="8" fill="#1e40af" />
                            <path d="M 48 38 Q 48 35 50 35 L 66 35 Q 68 35 68 38 L 68 60 Q 68 65 58 65 Q 48 65 48 60 Z" fill="#1e40af" />
                            <path d="M 50 75 Q 35 60 25 45 Q 20 35 30 35 Q 40 35 50 50 Q 60 35 70 35 Q 80 35 75 45 Q 65 60 50 75 Z" fill="url(#heartGradient2)" opacity="0.8" />
                        </svg>
                        <div>
                            <h1 class="text-2xl font-bold text-gray-800">Kindred</h1>
                            <p class="text-xs text-gray-500 -mt-1">Connecting generations</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-1">
                        <button onclick="showSection('profiles')" class="nav-btn flex items-center px-4 py-3 rounded-lg text-gray-600" id="btn-profiles">
                            <span class="mr-2">👤</span>
                            <span class="hidden sm:inline">Profiles</span>
                        </button>
                        <button onclick="showSection('planner')" class="nav-btn flex items-center px-4 py-3 rounded-lg text-gray-600" id="btn-planner">
                            <span class="mr-2">📅</span>
                            <span class="hidden sm:inline">Planner</span>
                        </button>
                        <button onclick="showSection('ideas')" class="nav-btn flex items-center px-4 py-3 rounded-lg text-gray-600" id="btn-ideas">
                            <span class="mr-2">💡</span>
                            <span class="hidden sm:inline">Ideas</span>
                        </button>
                        <button onclick="showSection('journal')" class="nav-btn flex items-center px-4 py-3 rounded-lg text-gray-600" id="btn-journal">
                            <span class="mr-2">📖</span>
                            <span class="hidden sm:inline">Journal</span>
                        </button>
                        <button onclick="showSection('reminders')" class="nav-btn flex items-center px-4 py-3 rounded-lg text-gray-600" id="btn-reminders">
                            <span class="mr-2">🔔</span>
                            <span class="hidden sm:inline">Reminders</span>
                        </button>
                        <button onclick="signOut()" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg hover:bg-red-200 ml-4">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 py-8">
            
            <!-- Profiles Section -->
            <div id="section-profiles" class="section active">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Grandchildren Profiles</h2>
                    <button onclick="openGrandchildModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 flex items-center text-lg">
                        <span class="mr-2">➕</span>
                        Add Grandchild
                    </button>
                </div>
                
                <div id="profilesContainer" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Profiles will be loaded here -->
                </div>
                
                <div id="noProfiles" class="text-center py-16">
                    <div class="text-6xl mb-4">👴👵</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">No grandchildren yet</h3>
                    <p class="text-gray-600 mb-6">Add your first grandchild to start connecting!</p>
                    <button onclick="openGrandchildModal()" class="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700">
                        Add First Grandchild
                    </button>
                </div>
            </div>

            <!-- Ideas Hub Section -->
            <div id="section-ideas" class="section">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Ideas Hub</h2>
                
                <div class="grid lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-semibold mb-4">Conversation Starters</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Age Group:</label>
                            <select id="ageSelect" onchange="updateConversationStarters()" class="w-full p-3 border rounded-lg text-lg">
                                <option value="5-8">5-8 years</option>
                                <option value="9-12">9-12 years</option>
                                <option value="12-15">12-15 years</option>
                                <option value="16-18">16-18 years</option>
                            </select>
                        </div>
                        <div id="conversationStarters" class="space-y-3"></div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h3 class="text-xl font-semibold mb-4">Activity Suggestions</h3>
                        <div id="activitySuggestions" class="space-y-4"></div>
                    </div>
                </div>
            </div>

            <!-- Planner Section -->
            <div id="section-planner" class="section">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Connection Planner</h2>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold mb-4">This Week's Connections</h3>
                    <div id="plannerContent" class="text-center py-8 text-gray-500">
                        Add some grandchildren to start planning connections!
                    </div>
                </div>
            </div>

            <!-- Journal Section -->
            <div id="section-journal" class="section">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Connection Journal</h2>
                    <button onclick="openJournalModal()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 flex items-center text-lg">
                        <span class="mr-2">➕</span>
                        Add Entry
                    </button>
                </div>
                
                <div id="journalContainer" class="space-y-4">
                    <!-- Journal entries will be loaded here -->
                </div>
                
                <div id="noJournal" class="text-center py-16">
                    <div class="text-6xl mb-4">📖</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">No journal entries yet</h3>
                    <p class="text-gray-600 mb-6">Start documenting your precious moments!</p>
                    <button onclick="openJournalModal()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700">
                        Add First Entry
                    </button>
                </div>
            </div>

            <!-- Reminders Section -->
            <div id="section-reminders" class="section">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Smart Reminders</h2>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold mb-4">Coming Soon!</h3>
                    <p class="text-gray-600">Smart reminders for birthdays, check-ins, and special events will be available soon.</p>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Global variables
        let supabase = null;
        let currentUser = null;
        let profiles = [];
        let journalEntries = [];
        let demoMode = false;

        // Initialize Supabase
        function initSupabase() {
            try {
                const SUPABASE_URL = 'https://cfrtpkgdgsylqnjeluqc.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmcnRwa2dkZ3N5bHFuamVsdXFjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg3MzQxODYsImV4cCI6MjA2NDMxMDE4Nn0.X4xU98fpKLrIOTXslrbx_vqpJ6am4dHf7uJbGm44jpg';
                
                if (window.supabase && window.supabase.createClient) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('Supabase initialized successfully');
                    return true;
                } else {
                    console.error('Supabase library not loaded');
                    return false;
                }
            } catch (error) {
                console.error('Error initializing Supabase:', error);
                return false;
            }
        }

        // Conversation starters and activities data
        const conversationStarters = {
            "5-8": [
                "What was the best part of your day today?",
                "Tell me about your favorite toy or game right now",
                "What's your favorite animal and why?",
                "What do you want to be when you grow up?",
                "What's your favorite color and what things are that color?"
            ],
            "9-12": [
                "What's your favorite subject in school and why?",
                "Tell me about your best friend - what do you like to do together?",
                "What's the coolest thing you've built or made recently?",
                "If you could have any superpower, what would it be?",
                "What's your favorite book or movie right now?"
            ],
            "12-15": [
                "What's the most interesting thing you learned in school this week?",
                "Tell me about your favorite game or hobby right now",
                "What's something that made you laugh recently?",
                "If you could travel anywhere, where would you go?",
                "What's challenging you right now, and how are you handling it?"
            ],
            "16-18": [
                "What are you most excited about these days?",
                "Tell me about your friends - what do you all like to do together?",
                "What's your favorite music right now? Can you share a song with me?",
                "What are you thinking about for after high school?",
                "What's something you're really passionate about?"
            ]
        };

        const activitySuggestions = {
            "5-8": {
                "Virtual": ["Simple video calls with show-and-tell", "Read books together over video", "Virtual zoo tours"],
                "Creative": ["Draw pictures for each other", "Make up silly songs together", "Create a scavenger hunt"],
                "In-Person": ["Baking cookies", "Simple crafts", "Playing in the park"]
            },
            "9-12": {
                "Virtual": ["Play Minecraft together", "Online puzzles", "Virtual museum tours"],
                "Creative": ["Start a family recipe book", "Create comic strips", "Build model kits"],
                "In-Person": ["Cooking projects", "Board games", "Nature photography"]
            },
            "12-15": {
                "Virtual": ["Online multiplayer games", "Watch movies together", "Virtual escape rooms"],
                "Creative": ["Create a family podcast", "Digital scrapbooking", "Photography challenges"],
                "In-Person": ["Cooking elaborate meals", "Strategic board games", "Hiking adventures"]
            },
            "16-18": {
                "Virtual": ["Play competitive games", "Virtual college tours", "Online classes together"],
                "Creative": ["Start a family blog", "Create video content", "Plan future trips"],
                "In-Person": ["Advanced cooking classes", "Workout sessions", "Exploring new places"]
            }
        };

        // Initialize app
        function initApp() {
            console.log('Initializing app...');
            const supabaseInitialized = initSupabase();
            
            if (supabaseInitialized && supabase) {
                checkAuthSession();
            } else {
                console.log('Supabase not available, showing auth modal');
                showAuthModal();
            }
            
            updateConversationStarters();
        }

        async function checkAuthSession() {
            try {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    currentUser = session.user;
                    hideAuthModal();
                    await loadUserData();
                } else {
                    showAuthModal();
                }
            } catch (error) {
                console.error('Error checking auth session:', error);
                showAuthModal();
            }
        }

        // Auth functions
        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        function showAuthTab(tab) {
            const loginTab = document.getElementById('loginTab');
            const signupTab = document.getElementById('signupTab');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            if (tab === 'login') {
                loginTab.classList.add('bg-white', 'shadow-sm');
                loginTab.classList.remove('text-gray-600');
                signupTab.classList.remove('bg-white', 'shadow-sm');
                signupTab.classList.add('text-gray-600');
                loginForm.classList.add('active');
                signupForm.classList.remove('active');
            } else {
                signupTab.classList.add('bg-white', 'shadow-sm');
                signupTab.classList.remove('text-gray-600');
                loginTab.classList.remove('bg-white', 'shadow-sm');
                loginTab.classList.add('text-gray-600');
                signupForm.classList.add('active');
                loginForm.classList.remove('active');
            }
        }

        // Auth handlers
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthMessage('Please fill in all fields', 'error');
                return;
            }

            if (!supabase) {
                showAuthMessage('Database connection not available. Try demo mode.', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });
                
                if (error) {
                    showAuthMessage(error.message, 'error');
                } else {
                    currentUser = data.user;
                    hideAuthModal();
                    await loadUserData();
                }
            } catch (error) {
                showAuthMessage('An error occurred during sign in', 'error');
            }
        }

        async function handleSignup() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const name = document.getElementById('signupName').value;
            
            if (!email || !password || !name) {
                showAuthMessage('Please fill in all fields', 'error');
                return;
            }

            if (password.length < 6) {
                showAuthMessage('Password must be at least 6 characters', 'error');
                return;
            }

            if (!supabase) {
                showAuthMessage('Database connection not available. Try demo mode.', 'error');
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            full_name: name,
                        }
                    }
                });
                
                if (error) {
                    showAuthMessage(error.message, 'error');
                } else {
                    showAuthMessage('Account created! Please check your email to verify your account.', 'success');
                }
            } catch (error) {
                showAuthMessage('An error occurred during sign up', 'error');
            }
        }

        function enterDemoMode() {
            demoMode = true;
            currentUser = { id: 'demo-user', email: 'demo@kindred.app' };
            
            // Load demo data
            profiles = [
                {
                    id: 'demo1',
                    name: 'Emma',
                    age: 16,
                    school: 'Lincoln High School',
                    interests: ['Photography', 'Basketball', 'Music'],
                    platforms: ['Instagram', 'Snapchat', 'TikTok'],
                    birthday: '2008-03-15',
                    notes: 'Loves indie music, plays on school basketball team',
                    last_contact: '2025-05-28'
                },
                {
                    id: 'demo2',
                    name: 'Jake',
                    age: 12,
                    school: 'Roosevelt Middle School',
                    interests: ['Gaming', 'Soccer', 'Drawing'],
                    platforms: ['Discord', 'YouTube', 'Instagram'],
                    birthday: '2012-07-22',
                    notes: 'Minecraft enthusiast, plays midfielder on soccer team',
                    last_contact: '2025-05-30'
                }
            ];
            
            journalEntries = [
                {
                    id: 'journal1',
                    grandchild_id: 'demo1',
                    title: 'Chat about Photography',
                    content: 'Emma showed me her latest photos from the school art show. She\'s really improving!',
                    entry_date: '2025-05-28',
                    profiles: { name: 'Emma' }
                }
            ];
            
            hideAuthModal();
            updateUI();
        }

        function showAuthMessage(message, type) {
            const messageEl = document.getElementById('authMessage');
            messageEl.textContent = message;
            messageEl.className = `mt-4 text-center text-sm ${type === 'error' ? 'text-red-600' : 'text-green-600'}`;
        }

        async function signOut() {
            if (demoMode) {
                demoMode = false;
                currentUser = null;
                profiles = [];
                journalEntries = [];
                showAuthModal();
                return;
            }

            try {
                if (supabase) {
                    await supabase.auth.signOut();
                }
                currentUser = null;
                profiles = [];
                journalEntries = [];
                showAuthModal();
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        // Data loading functions
        async function loadUserData() {
            if (demoMode) {
                updateUI();
                return;
            }

            await loadProfiles();
            await loadJournalEntries();
            updateUI();
        }

        async function loadProfiles() {
            if (demoMode || !supabase) return;

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('Error loading profiles:', error);
                } else {
                    profiles = data || [];
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
                profiles = [];
            }
        }

        async function loadJournalEntries() {
            if (demoMode || !supabase) return;

            try {
                const { data, error } = await supabase
                    .from('journal_entries')
                    .select('*, profiles(name)')
                    .eq('user_id', currentUser.id)
                    .order('entry_date', { ascending: false });
                
                if (error) {
                    console.error('Error loading journal entries:', error);
                } else {
                    journalEntries = data || [];
                }
            } catch (error) {
                console.error('Error loading journal entries:', error);
                journalEntries = [];
            }
        }

        // UI update functions
        function updateUI() {
            renderProfiles();
            renderJournalEntries();
        }

        function renderProfiles() {
            const container = document.getElementById('profilesContainer');
            const noProfiles = document.getElementById('noProfiles');
            
            if (profiles.length === 0) {
                container.innerHTML = '';
                noProfiles.style.display = 'block';
            } else {
                noProfiles.style.display = 'none';
                container.innerHTML = profiles.map(profile => createProfileCard(profile)).join('');
            }
        }

        function createProfileCard(profile) {
            const interests = Array.isArray(profile.interests) ? profile.interests.join(", ") : profile.interests || '';
            const platforms = Array.isArray(profile.platforms) ? profile.platforms : (profile.platforms ? [profile.platforms] : []);
            const age = profile.age || 'Unknown';
            const lastContact = profile.last_contact ? new Date(profile.last_contact).toLocaleDateString() : 'Never';
            
            const ageEmoji = age <= 8 ? '👶' : age <= 12 ? '👦' : age <= 16 ? '👧' : '🧑';
            
            return `
                <div class="card bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center mb-4">
                        <div class="text-4xl mr-4">${ageEmoji}</div>
                        <div>
                            <h3 class="text-xl font-semibold text-gray-800">${profile.name}</h3>
                            <p class="text-gray-600">Age ${age}</p>
                        </div>
                    </div>
                    <div class="space-y-2">
                        <p><strong>School:</strong> ${profile.school || 'Not specified'}</p>
                        <p><strong>Interests:</strong> ${interests || 'None listed'}</p>
                        <p><strong>Last Contact:</strong> ${lastContact}</p>
                    </div>
                    <div class="mt-4 flex flex-wrap gap-2">
                        ${platforms.map(platform => 
                            `<span class="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-sm">${platform}</span>`
                        ).join('')}
                    </div>
                    <div class="mt-4 flex space-x-2">
                        <button onclick="editProfile('${profile.id}')" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700">
                            Edit
                        </button>
                        <button onclick="deleteProfile('${profile.id}')" class="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600">
                            Delete
                        </button>
                    </div>
                </div>
            `;
        }

        function renderJournalEntries() {
            const container = document.getElementById('journalContainer');
            const noJournal = document.getElementById('noJournal');
            
            if (journalEntries.length === 0) {
                container.innerHTML = '';
                noJournal.style.display = 'block';
            } else {
                noJournal.style.display = 'none';
                container.innerHTML = journalEntries.map(entry => createJournalCard(entry)).join('');
            }
        }

        function createJournalCard(entry) {
            const grandchildName = entry.profiles?.name || 'Unknown';
            const entryDate = new Date(entry.entry_date).toLocaleDateString();
            
            return `
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center">
                            <span class="text-2xl mr-3">📝</span>
                            <div>
                                <h3 class="font-semibold text-lg">${entry.title}</h3>
                                <p class="text-gray-600">${grandchildName} • ${entryDate}</p>
                            </div>
                        </div>
                        <button onclick="deleteJournalEntry('${entry.id}')" class="text-red-500 hover:text-red-700">
                            🗑️
                        </button>
                    </div>
                    <p class="text-gray-700 bg-gray-50 p-4 rounded">${entry.content}</p>
                </div>
            `;
        }

        // Modal functions
        function openGrandchildModal(profileId = null) {
            const modal = document.getElementById('grandchildModal');
            const title = document.getElementById('modalTitle');
            
            if (profileId) {
                const profile = profiles.find(p => p.id === profileId);
                if (profile) {
                    title.textContent = 'Edit Grandchild';
                    document.getElementById('grandchildId').value = profile.id;
                    document.getElementById('grandchildName').value = profile.name;
                    document.getElementById('grandchildAge').value = profile.age || '';
                    document.getElementById('grandchildBirthday').value = profile.birthday || '';
                    document.getElementById('grandchildSchool').value = profile.school || '';
                    document.getElementById('grandchildInterests').value = Array.isArray(profile.interests) ? profile.interests.join(', ') : profile.interests || '';
                    document.getElementById('grandchildPlatforms').value = Array.isArray(profile.platforms) ? profile.platforms.join(', ') : profile.platforms || '';
                    document.getElementById('grandchildNotes').value = profile.notes || '';
                }
            } else {
                title.textContent = 'Add Grandchild';
                document.getElementById('grandchildId').value = '';
                document.getElementById('grandchildName').value = '';
                document.getElementById('grandchildAge').value = '';
                document.getElementById('grandchildBirthday').value = '';
                document.getElementById('grandchildSchool').value = '';
                document.getElementById('grandchildInterests').value = '';
                document.getElementById('grandchildPlatforms').value = '';
                document.getElementById('grandchildNotes').value = '';
            }
            
            modal.classList.add('active');
        }

        function closeGrandchildModal() {
            document.getElementById('grandchildModal').classList.remove('active');
        }

        function openJournalModal() {
            const modal = document.getElementById('journalModal');
            const select = document.getElementById('journalGrandchild');
            
            // Populate grandchildren dropdown
            select.innerHTML = '<option value="">Select a grandchild</option>';
            profiles.forEach(profile => {
                select.innerHTML += `<option value="${profile.id}">${profile.name}</option>`;
            });
            
            // Set today's date as default
            document.getElementById('journalDate').value = new Date().toISOString().split('T')[0];
            
            modal.classList.add('active');
        }

        function closeJournalModal() {
            document.getElementById('journalModal').classList.remove('active');
            document.getElementById('journalGrandchild').value = '';
            document.getElementById('journalTitle').value = '';
            document.getElementById('journalContent').value = '';
        }

        // Save functions
        async function saveGrandchild() {
            const profileId = document.getElementById('grandchildId').value;
            const profileData = {
                name: document.getElementById('grandchildName').value,
                age: parseInt(document.getElementById('grandchildAge').value) || null,
                birthday: document.getElementById('grandchildBirthday').value || null,
                school: document.getElementById('grandchildSchool').value || null,
                interests: document.getElementById('grandchildInterests').value.split(',').map(s => s.trim()).filter(s => s),
                platforms: document.getElementById('grandchildPlatforms').value.split(',').map(s => s.trim()).filter(s => s),
                notes: document.getElementById('grandchildNotes').value || null,
                last_contact: new Date().toISOString()
            };

            if (!profileData.name) {
                alert('Please enter a name');
                return;
            }

            if (demoMode) {
                // Demo mode - just update local data
                if (profileId) {
                    const index = profiles.findIndex(p => p.id === profileId);
                    if (index !== -1) {
                        profiles[index] = { ...profiles[index], ...profileData };
                    }
                } else {
                    profileData.id = 'demo' + Date.now();
                    profiles.push(profileData);
                }
                closeGrandchildModal();
                renderProfiles();
                return;
            }

            if (!supabase) {
                alert('Database not available. Try demo mode.');
                return;
            }

            try {
                profileData.user_id = currentUser.id;
                
                let result;
                if (profileId) {
                    // Update existing profile
                    result = await supabase
                        .from('profiles')
                        .update(profileData)
                        .eq('id', profileId)
                        .eq('user_id', currentUser.id);
                } else {
                    // Create new profile
                    result = await supabase
                        .from('profiles')
                        .insert([profileData]);
                }
                
                if (result.error) {
                    alert('Error saving profile: ' + result.error.message);
                } else {
                    closeGrandchildModal();
                    await loadProfiles();
                    renderProfiles();
                }
            } catch (error) {
                alert('Error saving profile: ' + error.message);
            }
        }

        async function saveJournalEntry() {
            const journalData = {
                grandchild_id: document.getElementById('journalGrandchild').value,
                title: document.getElementById('journalTitle').value,
                content: document.getElementById('journalContent').value,
                entry_date: document.getElementById('journalDate').value
            };

            if (!journalData.grandchild_id || !journalData.title || !journalData.content) {
                alert('Please fill in all required fields');
                return;
            }

            if (demoMode) {
                // Demo mode - just update local data
                const grandchild = profiles.find(p => p.id === journalData.grandchild_id);
                journalData.id = 'journal' + Date.now();
                journalData.profiles = { name: grandchild?.name || 'Unknown' };
                journalEntries.unshift(journalData);
                closeJournalModal();
                renderJournalEntries();
                return;
            }

            if (!supabase) {
                alert('Database not available. Try demo mode.');
                return;
            }

            try {
                journalData.user_id = currentUser.id;
                
                const { error } = await supabase
                    .from('journal_entries')
                    .insert([journalData]);
                
                if (error) {
                    alert('Error saving journal entry: ' + error.message);
                } else {
                    closeJournalModal();
                    await loadJournalEntries();
                    renderJournalEntries();
                }
            } catch (error) {
                alert('Error saving journal entry: ' + error.message);
            }
        }

        // Delete functions
        function editProfile(profileId) {
            openGrandchildModal(profileId);
        }

        async function deleteProfile(profileId) {
            if (confirm('Are you sure you want to delete this grandchild profile?')) {
                if (demoMode) {
                    profiles = profiles.filter(p => p.id !== profileId);
                    renderProfiles();
                    return;
                }

                if (!supabase) return;

                try {
                    const { error } = await supabase
                        .from('profiles')
                        .delete()
                        .eq('id', profileId)
                        .eq('user_id', currentUser.id);
                    
                    if (error) {
                        alert('Error deleting profile: ' + error.message);
                    } else {
                        await loadProfiles();
                        renderProfiles();
                    }
                } catch (error) {
                    alert('Error deleting profile: ' + error.message);
                }
            }
        }

        async function deleteJournalEntry(entryId) {
            if (confirm('Are you sure you want to delete this journal entry?')) {
                if (demoMode) {
                    journalEntries = journalEntries.filter(e => e.id !== entryId);
                    renderJournalEntries();
                    return;
                }

                if (!supabase) return;

                try {
                    const { error } = await supabase
                        .from('journal_entries')
                        .delete()
                        .eq('id', entryId)
                        .eq('user_id', currentUser.id);
                    
                    if (error) {
                        alert('Error deleting journal entry: ' + error.message);
                    } else {
                        await loadJournalEntries();
                        renderJournalEntries();
                    }
                } catch (error) {
                    alert('Error deleting journal entry: ' + error.message);
                }
            }
        }

        // Navigation functions
        function showSection(sectionName) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => section.classList.remove('active'));
            
            document.getElementById(`section-${sectionName}`).classList.add('active');
            
            const buttons = document.querySelectorAll('.nav-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${sectionName}`).classList.add('active');
        }

        function updateConversationStarters() {
            const age = document.getElementById('ageSelect').value;
            const startersDiv = document.getElementById('conversationStarters');
            const activitiesDiv = document.getElementById('activitySuggestions');
            
            // Update conversation starters
            startersDiv.innerHTML = '';
            if (conversationStarters[age]) {
                conversationStarters[age].forEach(starter => {
                    const div = document.createElement('div');
                    div.className = 'bg-blue-50 p-4 rounded-lg';
                    div.innerHTML = `<p class="text-gray-800">${starter}</p>`;
                    startersDiv.appendChild(div);
                });
            }
            
            // Update activities
            activitiesDiv.innerHTML = '';
            if (activitySuggestions[age]) {
                Object.entries(activitySuggestions[age]).forEach(([category, activities]) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.innerHTML = `
                        <h4 class="font-semibold text-gray-700 mb-2">${category}</h4>
                        <div class="space-y-2">
                            ${activities.map(activity => 
                                `<div class="bg-green-50 p-3 rounded flex items-center justify-between">
                                    <span>${activity}</span>
                                    <span class="text-yellow-500 cursor-pointer">⭐</span>
                                </div>`
                            ).join('')}
                        </div>
                    `;
                    activitiesDiv.appendChild(categoryDiv);
                });
            }
        }

        // Initialize the app when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            initApp();
            showSection('profiles');
        });
    </script>
</body>
</html>
